generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["typedSql", "postgresqlExtensions"] // Not yet update on dev branch
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ==================== USER ====================
//
model User {
  id        Int      @id @default(autoincrement()) // Primary Key
  firstname String
  lastname  String
  username  String   @unique
  email     String   @unique
  password  String
  avatarId  String?  @default("melon") // User avatar preset ID (matches DEFAULT_AVATAR_ID)
  createdAt DateTime @default(now())

  // One-to-Many relationship: One User can have 0 to many Recipes
  recipes         Recipe[]
  favoriteRecipes FavoriteRecipe[] // Many-to-many link with Recipe
  favoriteAPIRecipes FavoriteAPIRecipe[]
  notifications   Notification[]

  // self-relations for friendships
  sentRequests     Friendship[] @relation("Requester")
  receivedRequests Friendship[] @relation("Addressee")
}

//
// ==================== RECIPE ====================
//
model Recipe {
  recipeId     Int      @id @default(autoincrement()) // Primary Key
  userId       Int // Foreign Key referencing User
  recipeName   String
  description  String?
  photoUrl     String? // Store recipe photo path
  instructions String? // Cooking steps on 10/30
  videoUrl     String? // YouTube video link on 10/30
  createdAt    DateTime @default(now())

  // Relationship to User (Many Recipes belong to one User)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  recipeIngredients RecipeIngredient[]
  recipeCategories  RecipeCategory[]
  FavoriteRecipe    FavoriteRecipe[]
}

//
// ==================== FAVORITE RECIPE ====================
// (Junction table for Many-to-Many between User and Recipe)
//
model FavoriteRecipe {
  userId   Int
  recipeId Int

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [recipeId], onDelete: Cascade)

  // Composite Primary Key
  @@id([userId, recipeId])
}

//
// ==================== INGREDIENT ====================
//
model Ingredient {
  ingredientId   Int    @id @default(autoincrement())
  ingredientName String @unique

  // Relations
  recipeIngredients RecipeIngredient[]
}

//
// ==================== RECIPE INGREDIENT ====================
// (Junction table for Many-to-Many between Recipe and Ingredient)
//
model RecipeIngredient {
  recipeId     Int
  ingredientId Int
  quantity     String

  // Relations
  recipe     Recipe     @relation(fields: [recipeId], references: [recipeId], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [ingredientId], onDelete: Cascade)

  @@id([recipeId, ingredientId])
}

//
// ==================== CATEGORY ====================
//
model Category {
  categoryId   Int    @id @default(autoincrement())
  categoryName String @unique

  // Relations
  recipeCategories RecipeCategory[]
}

//
// ==================== RECIPE CATEGORY ====================
// (Junction table for Many-to-Many between Recipe and Category)
//
model RecipeCategory {
  recipeId   Int
  categoryId Int

  // Relations
  recipe   Recipe   @relation(fields: [recipeId], references: [recipeId], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [categoryId], onDelete: Cascade)

  @@id([recipeId, categoryId])
}

//
// ==================== FAVORITE API RECIPE ====================
// 
model FavoriteAPIRecipe {
  userId   Int
  apiId    String // TheMealDB's idMeal

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@id([userId, apiId])
}

//
// ==================== NOTIFICATION ====================
// 
model Notification {
  id         Int      @id @default(autoincrement())
  userId     Int
  type       String   // e.g., 'friend_request', 'friend_accept'
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id])
}

//
// ==================== FRIENDSHIP ====================
// 
model Friendship {
  id           Int      @id @default(autoincrement())
  requesterId  Int
  addresseeId  Int
  status       String   @default("none") // none | pending | accepted | rejected
  createdAt    DateTime @default(now())

  requester    User     @relation("Requester", fields: [requesterId], references: [id])
  addressee    User     @relation("Addressee", fields: [addresseeId], references: [id])

  @@unique([requesterId, addresseeId])
}